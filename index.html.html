<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºéµæ©Ÿæ¢°è²¡å‹™ç®¡ç†ç³»çµ± v1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { font-family: 'Microsoft JhengHei', sans-serif; }
        .mono { font-family: monospace; }
        .sidebar { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); }
        .sidebar-item { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-item:hover { background: rgba(59,130,246,0.1); border-left-color: #3b82f6; }
        .sidebar-item.active { background: rgba(59,130,246,0.2); border-left-color: #3b82f6; }
        .stat-card { background: linear-gradient(135deg, rgba(30,58,138,0.8) 0%, rgba(59,130,246,0.6) 100%); border: 1px solid rgba(255,255,255,0.1); }
        .stat-card.danger { background: linear-gradient(135deg, rgba(220,38,38,0.8) 0%, rgba(239,68,68,0.6) 100%); }
        .stat-card.success { background: linear-gradient(135deg, rgba(5,150,105,0.8) 0%, rgba(16,185,129,0.6) 100%); }
        .data-table { background: rgba(30,41,59,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .input-field { background: #1e293b; border: 1px solid #334155; color: #f8fafc; }
        .input-field:focus { border-color: #3b82f6; outline: none; }
        .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; cursor: pointer; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-danger { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); color: white; cursor: pointer; }
        .btn-danger:hover { opacity: 0.9; }
        .modal-overlay { background: rgba(0,0,0,0.7); }
        .modal-content { background: #1e293b; border: 1px solid #334155; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .tag-urgent { background: #ef4444; }
        .tag-normal { background: #10b981; }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- å´é‚Šæ¬„ -->
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col">
            <div class="p-4 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center"><span class="text-xl">ğŸ­</span></div>
                    <div><h1 class="font-bold text-lg">æ™ºéµæ©Ÿæ¢°</h1><p class="text-xs text-slate-400">è²¡å‹™ç®¡ç†ç³»çµ±</p></div>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span class="text-xs text-slate-400">æœ¬æ©Ÿç‰ˆ</span>
                    <span class="text-xs text-slate-500 ml-auto mono">v1.1</span>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <div class="px-3 mb-2"><span class="text-xs font-medium text-slate-500 uppercase">ä¸»è¦åŠŸèƒ½</span></div>
                <div class="sidebar-item active flex items-center gap-3 px-4 py-3" data-page="dashboard">
                    <span class="text-lg">ğŸ“Š</span><div><p class="font-medium">å„€è¡¨æ¿</p><p class="text-xs text-slate-400">ç¸½è¦½çµ±è¨ˆ</p></div>
                </div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="ar">
                    <span class="text-lg">ğŸ’°</span><div><p class="font-medium">æ‡‰æ”¶å¸³æ¬¾</p><p class="text-xs text-slate-400">æ”¶æ¬¾è¿½è¹¤</p></div>
                </div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="ap">
                    <span class="text-lg">ğŸ“‹</span><div><p class="font-medium">æ‡‰ä»˜å¸³æ¬¾</p><p class="text-xs text-slate-400">ä»˜æ¬¾ç®¡ç†</p></div>
                </div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="projects">
                    <span class="text-lg">ğŸ—ï¸</span><div><p class="font-medium">å·¥ç¨‹å°ˆæ¡ˆ</p><p class="text-xs text-slate-400">å°ˆæ¡ˆæˆæœ¬</p></div>
                </div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="commission">
                    <span class="text-lg">ğŸ’¼</span><div><p class="font-medium">ä½£é‡‘ç®¡ç†</p><p class="text-xs text-slate-400">ä»£ç†/è½‰ä»‹/å›æ‰£</p></div>
                </div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="bonus">
                    <span class="text-lg">ğŸ</span><div><p class="font-medium">çé‡‘çµç®—</p><p class="text-xs text-slate-400">è¨‚å–®-ä½£é‡‘-æˆæœ¬Ã—1.15</p></div>
                </div>
                <div class="px-3 my-4"><hr class="border-slate-700"></div>
                <div class="px-3 mb-2"><span class="text-xs font-medium text-slate-500 uppercase">ç³»çµ±</span></div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="settings">
                    <span class="text-lg">âš™ï¸</span><div><p class="font-medium">ç³»çµ±è¨­å®š</p><p class="text-xs text-slate-400">å…¬å¸/å®¢æˆ¶/ä¾›æ‡‰å•†</p></div>
                </div>
                <div class="sidebar-item flex items-center gap-3 px-4 py-3" data-page="backup">
                    <span class="text-lg">ğŸ’¾</span><div><p class="font-medium">è³‡æ–™å‚™ä»½</p><p class="text-xs text-slate-400">åŒ¯å‡º/åŒ¯å…¥</p></div>
                </div>
            </nav>
        </aside>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="flex-1 overflow-y-auto bg-slate-900">
            <!-- å„€è¡¨æ¿ -->
            <div id="page-dashboard" class="page-content active p-6">
                <h2 class="text-2xl font-bold mb-6">ğŸ“Š å„€è¡¨æ¿</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card rounded-xl p-4">
                        <p class="text-sm text-slate-300">æ‡‰æ”¶å¸³æ¬¾ç¸½é¡</p>
                        <p id="statArTotal" class="text-2xl font-bold mono">NT$ 0</p>
                        <p class="text-xs text-slate-400"><span id="statArCount">0</span> ç­†å¾…æ”¶</p>
                    </div>
                    <div class="stat-card danger rounded-xl p-4">
                        <p class="text-sm text-slate-300">é€¾æœŸå¸³æ¬¾</p>
                        <p id="statOverdue" class="text-2xl font-bold mono">NT$ 0</p>
                        <p class="text-xs text-slate-400"><span id="statOverdueCount">0</span> ç­†é€¾æœŸ</p>
                    </div>
                    <div class="stat-card rounded-xl p-4">
                        <p class="text-sm text-slate-300">æ‡‰ä»˜å¸³æ¬¾</p>
                        <p id="statApTotal" class="text-2xl font-bold mono">NT$ 0</p>
                        <p class="text-xs text-slate-400"><span id="statApCount">0</span> ç­†å¾…ä»˜</p>
                    </div>
                    <div class="stat-card success rounded-xl p-4">
                        <p class="text-sm text-slate-300">å¯ç™¼æ”¾çé‡‘</p>
                        <p id="statBonus" class="text-2xl font-bold mono">NT$ 0</p>
                        <p class="text-xs text-slate-400"><span id="statBonusCount">0</span> å€‹å°ˆæ¡ˆ</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="data-table rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-slate-700"><h3 class="font-bold">é€²è¡Œä¸­å°ˆæ¡ˆ</h3></div>
                        <div id="dashboardProjects" class="p-4 text-slate-400">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="data-table rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-slate-700"><h3 class="font-bold">è¿‘æœŸåˆ°æœŸå¸³æ¬¾</h3></div>
                        <div id="dashboardDue" class="p-4 text-slate-400">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- æ‡‰æ”¶å¸³æ¬¾ -->
            <div id="page-ar" class="page-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ’° æ‡‰æ”¶å¸³æ¬¾ç®¡ç†</h2>
                    <button id="btnAddAr" class="btn-primary px-4 py-2 rounded-lg">+ æ–°å¢</button>
                </div>
                <div class="mb-4">
                    <input type="text" id="arSearch" placeholder="æœå°‹å°ˆæ¡ˆã€å®¢æˆ¶ã€é¡å‹..." class="input-field rounded-lg px-4 py-2 w-full max-w-md">
                </div>
                <div class="data-table rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-slate-400 border-b border-slate-700">
                                <th class="p-4">å°ˆæ¡ˆ</th><th class="p-4">å®¢æˆ¶</th><th class="p-4">é¡å‹</th>
                                <th class="p-4 text-right">æ‡‰æ”¶</th><th class="p-4 text-right">å·²æ”¶</th>
                                <th class="p-4">åˆ°æœŸæ—¥</th><th class="p-4">ç‹€æ…‹</th><th class="p-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="arTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- æ‡‰ä»˜å¸³æ¬¾ -->
            <div id="page-ap" class="page-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ“‹ æ‡‰ä»˜å¸³æ¬¾ç®¡ç†</h2>
                    <button id="btnAddAp" class="btn-primary px-4 py-2 rounded-lg">+ æ–°å¢</button>
                </div>
                <div class="mb-4">
                    <input type="text" id="apSearch" placeholder="æœå°‹å°ˆæ¡ˆã€ä¾›æ‡‰å•†ã€ä»˜æ¬¾æ–¹å¼..." class="input-field rounded-lg px-4 py-2 w-full max-w-md">
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="data-table rounded-xl p-4"><p class="text-sm text-slate-400">ğŸ“ æ”¯ç¥¨</p><p id="apCheck" class="text-xl font-bold mono">NT$ 0</p></div>
                    <div class="data-table rounded-xl p-4"><p class="text-sm text-slate-400">ğŸ¦ åŒ¯æ¬¾</p><p id="apTransfer" class="text-xl font-bold mono">NT$ 0</p></div>
                    <div class="data-table rounded-xl p-4"><p class="text-sm text-slate-400">ğŸ’µ ç¾é‡‘</p><p id="apCash" class="text-xl font-bold mono">NT$ 0</p></div>
                </div>
                <div class="data-table rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-slate-400 border-b border-slate-700">
                                <th class="p-4">ä»˜æ¬¾æ–¹å¼</th><th class="p-4">å°ˆæ¡ˆ</th><th class="p-4">ä¾›æ‡‰å•†</th>
                                <th class="p-4 text-right">é‡‘é¡</th><th class="p-4">åˆ°æœŸæ—¥</th><th class="p-4">ç‹€æ…‹</th><th class="p-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="apTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- å·¥ç¨‹å°ˆæ¡ˆ -->
            <div id="page-projects" class="page-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ—ï¸ å·¥ç¨‹å°ˆæ¡ˆç®¡ç†</h2>
                    <button id="btnAddProject" class="btn-primary px-4 py-2 rounded-lg">+ æ–°å¢å°ˆæ¡ˆ</button>
                </div>
                <div class="mb-4">
                    <input type="text" id="projectSearch" placeholder="æœå°‹å°ˆæ¡ˆä»£è™Ÿã€åç¨±ã€å®¢æˆ¶..." class="input-field rounded-lg px-4 py-2 w-full max-w-md">
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-6">
                    <p class="text-sm text-slate-400">ğŸ’¡ çé‡‘å…¬å¼ï¼š<span class="text-amber-400 mono">å°ˆæ¡ˆçé‡‘ = è¨‚å–®é‡‘é¡ - ä½£é‡‘ - (ææ–™è²» + äººå·¥è²») Ã— 1.15</span></p>
                </div>
                <div id="projectList" class="space-y-4"></div>
            </div>

            <!-- ä½£é‡‘ç®¡ç† -->
            <div id="page-commission" class="page-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ’¼ ä½£é‡‘ç®¡ç†</h2>
                    <button id="btnAddCommission" class="btn-primary px-4 py-2 rounded-lg">+ æ–°å¢ä½£é‡‘</button>
                </div>
                <div class="mb-4">
                    <input type="text" id="commSearch" placeholder="æœå°‹å°ˆæ¡ˆã€é¡å‹ã€èªªæ˜..." class="input-field rounded-lg px-4 py-2 w-full max-w-md">
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="data-table rounded-xl p-4"><p class="text-sm text-slate-400">ğŸ¤ ä»£ç†ä½£é‡‘</p><p id="commAgent" class="text-xl font-bold mono">NT$ 0</p></div>
                    <div class="data-table rounded-xl p-4"><p class="text-sm text-slate-400">ğŸ”— è½‰ä»‹ä½£é‡‘</p><p id="commReferral" class="text-xl font-bold mono">NT$ 0</p></div>
                    <div class="data-table rounded-xl p-4"><p class="text-sm text-slate-400">ğŸ’µ å›æ‰£</p><p id="commRebate" class="text-xl font-bold mono">NT$ 0</p></div>
                </div>
                <div class="data-table rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-slate-400 border-b border-slate-700">
                                <th class="p-4">å°ˆæ¡ˆ</th><th class="p-4">é¡å‹</th><th class="p-4">èªªæ˜</th>
                                <th class="p-4 text-right">é‡‘é¡</th><th class="p-4">æ—¥æœŸ</th><th class="p-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="commTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- çé‡‘çµç®— -->
            <div id="page-bonus" class="page-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ çé‡‘çµç®—</h2>
                    <button id="btnCalcBonus" class="btn-primary px-4 py-2 rounded-lg">ğŸ”„ é‡æ–°è¨ˆç®—</button>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-6">
                    <p class="text-sm"><span class="text-slate-400">å…¬å¼ï¼š</span><span class="text-amber-400 mono">çé‡‘ = è¨‚å–® - ä½£é‡‘ - (ææ–™+äººå·¥) Ã— 1.15</span></p>
                    <p class="text-sm mt-1"><span class="text-slate-400">ç™¼æ”¾æ¢ä»¶ï¼š</span><span class="text-green-400">æ”¶æ¬¾ç‡ â‰¥ 80% ä¸” çé‡‘ > 0</span></p>
                </div>
                <div class="data-table rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-slate-400 border-b border-slate-700">
                                <th class="p-4">å°ˆæ¡ˆ</th><th class="p-4 text-right">è¨‚å–®</th><th class="p-4 text-right">ä½£é‡‘</th>
                                <th class="p-4 text-right">æˆæœ¬Ã—1.15</th><th class="p-4 text-right">çé‡‘</th>
                                <th class="p-4 text-center">æ”¶æ¬¾ç‡</th><th class="p-4">ç‹€æ…‹</th><th class="p-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bonusTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ç³»çµ±è¨­å®š -->
            <div id="page-settings" class="page-content p-6">
                <h2 class="text-2xl font-bold mb-6">âš™ï¸ ç³»çµ±è¨­å®š</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="data-table rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4">å…¬å¸è³‡è¨Š</h3>
                        <div class="space-y-4">
                            <div><label class="block text-sm text-slate-400 mb-1">å…¬å¸åç¨±</label><input type="text" id="companyName" class="input-field w-full rounded-lg px-4 py-2" value="æ™ºéµæ©Ÿæ¢°å·¥ç¨‹æœ‰é™å…¬å¸"></div>
                            <div><label class="block text-sm text-slate-400 mb-1">è¯çµ¡äºº</label><input type="text" id="companyContact" class="input-field w-full rounded-lg px-4 py-2" value="ç‹æ™ºå½¥"></div>
                            <div><label class="block text-sm text-slate-400 mb-1">é›»è©±</label><input type="text" id="companyPhone" class="input-field w-full rounded-lg px-4 py-2" value="03-4691369"></div>
                            <button id="btnSaveCompany" class="btn-primary px-4 py-2 rounded-lg w-full">å„²å­˜å…¬å¸è³‡è¨Š</button>
                        </div>
                    </div>
                    <div class="data-table rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">å®¢æˆ¶åˆ—è¡¨</h3>
                            <button id="btnAddCustomer" class="text-blue-400 hover:text-blue-300">+ æ–°å¢</button>
                        </div>
                        <div id="customerList" class="space-y-2"></div>
                    </div>
                    <div class="data-table rounded-xl p-6 lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">ä¾›æ‡‰å•†åˆ—è¡¨</h3>
                            <button id="btnAddSupplier" class="text-blue-400 hover:text-blue-300">+ æ–°å¢</button>
                        </div>
                        <div id="supplierList" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- è³‡æ–™å‚™ä»½ -->
            <div id="page-backup" class="page-content p-6">
                <h2 class="text-2xl font-bold mb-6">ğŸ’¾ è³‡æ–™å‚™ä»½</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="data-table rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4">åŒ¯å‡ºè³‡æ–™</h3>
                        <p class="text-sm text-slate-400 mb-4">å°‡æ‰€æœ‰è³‡æ–™åŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼Œå¯ç”¨æ–¼å‚™ä»½æˆ–è½‰ç§»ã€‚</p>
                        <div id="exportStats" class="mb-4 p-4 bg-slate-800 rounded-lg text-sm space-y-1"></div>
                        <button id="btnExport" class="btn-primary px-4 py-2 rounded-lg w-full">ğŸ“¥ åŒ¯å‡º JSON</button>
                    </div>
                    <div class="data-table rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4">åŒ¯å…¥è³‡æ–™ (JSON)</h3>
                        <p class="text-sm text-slate-400 mb-4">å¾ JSON æª”æ¡ˆåŒ¯å…¥è³‡æ–™ï¼Œå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚</p>
                        <div class="mb-4">
                            <label class="block w-full p-8 border-2 border-dashed border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition">
                                <span class="text-slate-400" id="importFileLabel">é»æ“Šé¸æ“‡ JSON æª”æ¡ˆ</span>
                                <input type="file" id="importFile" accept=".json" class="hidden">
                            </label>
                        </div>
                        <div id="importPreview" class="mb-4 hidden p-4 bg-slate-800 rounded-lg text-sm space-y-1"></div>
                        <button id="btnImport" class="btn-danger px-4 py-2 rounded-lg w-full" disabled>ğŸ“¤ ç¢ºèªåŒ¯å…¥ï¼ˆå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰</button>
                    </div>
                </div>
                <div class="data-table rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4">ğŸ“„ CSV æ‰¹æ¬¡åŒ¯å…¥</h3>
                    <p class="text-sm text-slate-400 mb-4">å¾ CSV æª”æ¡ˆæ‰¹æ¬¡åŒ¯å…¥è³‡æ–™ï¼Œæ–°è³‡æ–™å°‡<span class="text-amber-400">åˆä½µ</span>è‡³ç¾æœ‰è³‡æ–™ï¼ˆä¸æœƒè¦†è“‹ï¼‰ã€‚</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">å®¢æˆ¶</label>
                            <label class="block w-full p-3 border border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition text-sm">
                                <span id="csvCustLabel">é¸æ“‡æª”æ¡ˆ</span>
                                <input type="file" id="csvCustomers" accept=".csv" class="hidden">
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">ä¾›æ‡‰å•†</label>
                            <label class="block w-full p-3 border border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition text-sm">
                                <span id="csvSupLabel">é¸æ“‡æª”æ¡ˆ</span>
                                <input type="file" id="csvSuppliers" accept=".csv" class="hidden">
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">å°ˆæ¡ˆ</label>
                            <label class="block w-full p-3 border border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition text-sm">
                                <span id="csvProjLabel">é¸æ“‡æª”æ¡ˆ</span>
                                <input type="file" id="csvProjects" accept=".csv" class="hidden">
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">æ‡‰æ”¶å¸³æ¬¾</label>
                            <label class="block w-full p-3 border border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition text-sm">
                                <span id="csvArLabel">é¸æ“‡æª”æ¡ˆ</span>
                                <input type="file" id="csvAr" accept=".csv" class="hidden">
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">æ‡‰ä»˜å¸³æ¬¾</label>
                            <label class="block w-full p-3 border border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition text-sm">
                                <span id="csvApLabel">é¸æ“‡æª”æ¡ˆ</span>
                                <input type="file" id="csvAp" accept=".csv" class="hidden">
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">ä½£é‡‘</label>
                            <label class="block w-full p-3 border border-slate-600 rounded-lg text-center cursor-pointer hover:border-blue-500 transition text-sm">
                                <span id="csvCommLabel">é¸æ“‡æª”æ¡ˆ</span>
                                <input type="file" id="csvCommissions" accept=".csv" class="hidden">
                            </label>
                        </div>
                    </div>
                    <div id="csvPreview" class="mb-4 hidden p-4 bg-slate-800 rounded-lg text-sm space-y-1"></div>
                    <button id="btnCsvImport" class="btn-primary px-4 py-2 rounded-lg w-full" disabled>ğŸ“¤ åŒ¯å…¥ CSV è³‡æ–™</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <!-- Modal -->
    <div id="modalContainer"></div>

    <script>
    // ============================================================
    // æ™ºéµæ©Ÿæ¢°è²¡å‹™ç®¡ç†ç³»çµ± v1.1
    // ============================================================
    (function() {
        'use strict';

        var VERSION = '1.1';
        var FACTOR = 1.15;
        var THRESHOLD = 80;

        var DEFAULT_CUSTOMERS = [
            {code:'C001', name:'åœ‹ç‘æ±½è»Šè‚¡ä»½æœ‰é™å…¬å¸', shortName:'åœ‹ç‘æ±½è»Š'},
            {code:'C002', name:'é•·æ–°åœ‹éš›å·¥ç¨‹æœ‰é™å…¬å¸', shortName:'é•·æ–°åœ‹éš›'},
            {code:'C003', name:'é•·è–å„€å™¨è‚¡ä»½æœ‰é™å…¬å¸', shortName:'é•·è–å„€å™¨'}
        ];

        var AR_TYPES = {deposit:'è¨‚é‡‘', delivery:'é€²å ´æ¬¾', acceptance:'é©—æ”¶æ¬¾', final:'å°¾æ¬¾'};
        var PM_TYPES = {CHECK:'æ”¯ç¥¨', TRANSFER:'åŒ¯æ¬¾', CASH:'ç¾é‡‘'};
        var COMM_TYPES = {agent:'ä»£ç†ä½£é‡‘', referral:'è½‰ä»‹ä½£é‡‘', rebate:'å›æ‰£'};

        // ============== å·¥å…·å‡½æ•¸ ==============
        function $(id) { return document.getElementById(id); }
        function $$(sel) { return document.querySelectorAll(sel); }
        function fmt(n) { return 'NT$ ' + (n||0).toLocaleString(); }
        function fmtDate(d) { return d ? new Date(d).toLocaleDateString('zh-TW') : '-'; }
        function genId(p) { return (p||'id') + '_' + Date.now() + '_' + Math.random().toString(36).substr(2,4); }
        function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function escAttr(s) { return String(s==null?'':s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function getData(k) {
            try { return JSON.parse(localStorage.getItem('zt_'+k)) || []; }
            catch(e) { return []; }
        }
        function setData(k, v) {
            try {
                localStorage.setItem('zt_'+k, JSON.stringify(v));
                return true;
            } catch(e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    toast('å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹åŒ¯å‡ºå‚™ä»½å¾Œæ¸…ç†è³‡æ–™', 'error');
                } else {
                    toast('å„²å­˜å¤±æ•—ï¼š' + e.message, 'error');
                }
                return false;
            }
        }
        function getObj(k) {
            try { return JSON.parse(localStorage.getItem('zt_'+k)) || {}; }
            catch(e) { return {}; }
        }
        function setObj(k, v) {
            try {
                localStorage.setItem('zt_'+k, JSON.stringify(v));
                return true;
            } catch(e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    toast('å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹åŒ¯å‡ºå‚™ä»½å¾Œæ¸…ç†è³‡æ–™', 'error');
                } else {
                    toast('å„²å­˜å¤±æ•—ï¼š' + e.message, 'error');
                }
                return false;
            }
        }

        function toast(msg, type) {
            var c = $('toastContainer');
            var colors = {success:'bg-green-600', error:'bg-red-600', info:'bg-blue-600'};
            var t = document.createElement('div');
            t.className = 'toast ' + (colors[type]||colors.info) + ' px-4 py-3 rounded-lg shadow-lg text-white';
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(function(){ t.remove(); }, 3000);
        }

        function closeModal() {
            $('modalContainer').innerHTML = '';
        }

        function confirmDialog(msg, onConfirm) {
            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-sm p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-4">ç¢ºèªæ“ä½œ</h3>' +
                '<p class="text-slate-300 mb-6">' + msg + '</p>' +
                '<div class="flex justify-end gap-2">' +
                '<button id="mConfirmCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mConfirmOk" class="btn-danger px-4 py-2 rounded-lg">ç¢ºèªåˆªé™¤</button>' +
                '</div></div></div>';
            $('modalContainer').innerHTML = html;
            $('mConfirmCancel').onclick = closeModal;
            $('mConfirmOk').onclick = function() {
                closeModal();
                onConfirm();
            };
        }

        // ============== é€£å‹•æ›´æ–° ==============
        function updateProjectCollectionRate(projectId) {
            if (!projectId) return;
            var arList = getData('ar');
            var totalAmount = 0;
            var totalPaid = 0;
            for (var i = 0; i < arList.length; i++) {
                if (arList[i].projectId === projectId) {
                    totalAmount += arList[i].amount || 0;
                    totalPaid += arList[i].paidAmount || 0;
                }
            }
            var rate = totalAmount > 0 ? (totalPaid / totalAmount * 100) : 0;
            var projects = getData('projects');
            for (var j = 0; j < projects.length; j++) {
                if (projects[j].id === projectId) {
                    projects[j].collectionRate = Math.min(rate, 100);
                    break;
                }
            }
            setData('projects', projects);
        }

        function updateProjectCommission(projectId) {
            if (!projectId) return;
            var commList = getData('commissions');
            var total = 0;
            for (var i = 0; i < commList.length; i++) {
                if (commList[i].projectId === projectId) {
                    total += commList[i].amount || 0;
                }
            }
            var projects = getData('projects');
            for (var j = 0; j < projects.length; j++) {
                if (projects[j].id === projectId) {
                    projects[j].commission = total;
                    break;
                }
            }
            setData('projects', projects);
        }

        // ============== é é¢åˆ‡æ› ==============
        function showPage(pageId) {
            var pages = $$('.page-content');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
            }
            var target = $('page-' + pageId);
            if (target) target.classList.add('active');

            var items = $$('.sidebar-item');
            for (var j = 0; j < items.length; j++) {
                items[j].classList.remove('active');
                if (items[j].getAttribute('data-page') === pageId) {
                    items[j].classList.add('active');
                }
            }

            switch(pageId) {
                case 'dashboard': loadDashboard(); break;
                case 'ar': loadArList(); break;
                case 'ap': loadApList(); break;
                case 'projects': loadProjectList(); break;
                case 'commission': loadCommissionList(); break;
                case 'bonus': loadBonusList(); break;
                case 'settings': loadSettings(); break;
                case 'backup': loadBackupPage(); break;
            }
        }

        // ============== å„€è¡¨æ¿ ==============
        function loadDashboard() {
            var arList = getData('ar');
            var apList = getData('ap');
            var projects = getData('projects');

            var arTotal = 0, arCount = 0, overdueTotal = 0, overdueCount = 0;
            var now = new Date();

            for (var i = 0; i < arList.length; i++) {
                var ar = arList[i];
                arTotal += ar.amount || 0;
                var paid = ar.paidAmount || 0;
                if (paid < ar.amount) {
                    arCount++;
                    if (new Date(ar.dueDate) < now) {
                        overdueTotal += ar.amount - paid;
                        overdueCount++;
                    }
                }
            }

            var apTotal = 0, apCount = 0;
            for (var j = 0; j < apList.length; j++) {
                if (apList[j].status !== 'paid') {
                    apTotal += apList[j].amount || 0;
                    apCount++;
                }
            }

            var bonusTotal = 0, bonusCount = 0;
            for (var k = 0; k < projects.length; k++) {
                var p = projects[k];
                var cost = ((p.materialCost||0) + (p.laborCost||0)) * FACTOR;
                var bonus = (p.orderAmount||0) - (p.commission||0) - cost;
                // Only count unpaid bonuses that meet criteria
                if ((p.collectionRate||0) >= THRESHOLD && bonus > 0 && p.bonusStatus !== 'paid') {
                    bonusTotal += bonus;
                    bonusCount++;
                }
            }

            $('statArTotal').textContent = fmt(arTotal);
            $('statArCount').textContent = arCount;
            $('statOverdue').textContent = fmt(overdueTotal);
            $('statOverdueCount').textContent = overdueCount;
            $('statApTotal').textContent = fmt(apTotal);
            $('statApCount').textContent = apCount;
            $('statBonus').textContent = fmt(bonusTotal);
            $('statBonusCount').textContent = bonusCount;

            var projHtml = '';
            if (projects.length === 0) {
                projHtml = '<p class="text-slate-400">å°šç„¡å°ˆæ¡ˆ</p>';
            } else {
                for (var m = 0; m < Math.min(5, projects.length); m++) {
                    var proj = projects[m];
                    projHtml += '<div class="flex justify-between py-2 border-b border-slate-700"><span>' + esc(proj.code) + ' ' + esc(proj.name) + '</span><span class="text-amber-400">' + (proj.collectionRate||0).toFixed(1) + '%</span></div>';
                }
            }
            $('dashboardProjects').innerHTML = projHtml;

            var pending = arList.filter(function(a) { return (a.paidAmount||0) < a.amount; });
            pending.sort(function(a,b) { return new Date(a.dueDate) - new Date(b.dueDate); });
            var dueHtml = '';
            if (pending.length === 0) {
                dueHtml = '<p class="text-slate-400">ç„¡å¾…æ”¶å¸³æ¬¾</p>';
            } else {
                for (var n = 0; n < Math.min(5, pending.length); n++) {
                    var ar2 = pending[n];
                    dueHtml += '<div class="flex justify-between py-2 border-b border-slate-700"><span>' + esc(ar2.projectCode||'-') + '</span><span class="mono">' + fmt(ar2.amount - (ar2.paidAmount||0)) + '</span><span>' + fmtDate(ar2.dueDate) + '</span></div>';
                }
            }
            $('dashboardDue').innerHTML = dueHtml;
        }

        // ============== æ‡‰æ”¶å¸³æ¬¾ ==============
        function loadArList() {
            var arList = getData('ar');
            var searchVal = ($('arSearch') ? $('arSearch').value : '').toLowerCase();
            var tbody = $('arTableBody');

            var filtered = arList;
            if (searchVal) {
                filtered = arList.filter(function(ar) {
                    return (ar.projectCode||'').toLowerCase().indexOf(searchVal) >= 0 ||
                           (ar.customerName||'').toLowerCase().indexOf(searchVal) >= 0 ||
                           (AR_TYPES[ar.type]||ar.type||'').toLowerCase().indexOf(searchVal) >= 0;
                });
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400">' + (searchVal ? 'ç„¡ç¬¦åˆæœå°‹çµæœ' : 'æš«ç„¡æ‡‰æ”¶å¸³æ¬¾ï¼Œé»æ“Šã€Œæ–°å¢ã€å»ºç«‹') + '</td></tr>';
                return;
            }

            var html = '';
            var now = new Date();
            for (var i = 0; i < filtered.length; i++) {
                var ar = filtered[i];
                var paid = ar.paidAmount || 0;
                var status, statusCls;
                if (paid >= ar.amount) { status = 'å·²å…¥å¸³'; statusCls = 'bg-green-500/20 text-green-300'; }
                else if (new Date(ar.dueDate) < now) { status = 'é€¾æœŸ'; statusCls = 'bg-red-500/20 text-red-300'; }
                else if (paid > 0) { status = 'éƒ¨åˆ†æ”¶æ¬¾'; statusCls = 'bg-amber-500/20 text-amber-300'; }
                else { status = 'å¾…æ”¶æ¬¾'; statusCls = 'bg-blue-500/20 text-blue-300'; }

                html += '<tr class="border-t border-slate-700 hover:bg-slate-800/50">' +
                    '<td class="p-4">' + esc(ar.projectCode||'-') + '</td>' +
                    '<td class="p-4">' + esc(ar.customerName||'-') + '</td>' +
                    '<td class="p-4">' + esc(AR_TYPES[ar.type]||ar.type) + '</td>' +
                    '<td class="p-4 text-right mono">' + fmt(ar.amount) + '</td>' +
                    '<td class="p-4 text-right mono text-green-400">' + fmt(paid) + '</td>' +
                    '<td class="p-4">' + fmtDate(ar.dueDate) + '</td>' +
                    '<td class="p-4"><span class="px-2 py-1 rounded text-xs ' + statusCls + '">' + status + '</span></td>' +
                    '<td class="p-4">' +
                    '<button class="text-blue-400 mr-2" data-edit-ar="' + ar.id + '">ç·¨è¼¯</button>' +
                    '<button class="text-green-400 mr-2" data-pay-ar="' + ar.id + '">æ”¶æ¬¾</button>' +
                    '<button class="text-red-400" data-delete-ar="' + ar.id + '">åˆªé™¤</button></td></tr>';
            }
            tbody.innerHTML = html;
        }

        function openArModal(editId) {
            var arList = getData('ar');
            var customers = getData('customers');
            if (customers.length === 0) customers = DEFAULT_CUSTOMERS;
            var projects = getData('projects');

            var ar = null;
            if (editId) {
                for (var i = 0; i < arList.length; i++) {
                    if (arList[i].id === editId) { ar = arList[i]; break; }
                }
            }

            var projOpts = '<option value="">é¸æ“‡å°ˆæ¡ˆ</option>';
            for (var p = 0; p < projects.length; p++) {
                var sel = (ar && ar.projectId === projects[p].id) ? ' selected' : '';
                projOpts += '<option value="' + projects[p].id + '"' + sel + '>' + projects[p].code + '</option>';
            }

            var custOpts = '<option value="">é¸æ“‡å®¢æˆ¶</option>';
            for (var c = 0; c < customers.length; c++) {
                var csel = (ar && ar.customerCode === customers[c].code) ? ' selected' : '';
                custOpts += '<option value="' + customers[c].code + '"' + csel + '>' + (customers[c].shortName||customers[c].name) + '</option>';
            }

            var typeOpts = '';
            for (var t in AR_TYPES) {
                var tsel = (ar && ar.type === t) ? ' selected' : '';
                typeOpts += '<option value="' + t + '"' + tsel + '>' + AR_TYPES[t] + '</option>';
            }

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-lg p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">' + (ar ? 'ç·¨è¼¯' : 'æ–°å¢') + 'æ‡‰æ”¶å¸³æ¬¾</h3>' +
                '<div class="space-y-4">' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">å°ˆæ¡ˆ <span class="text-red-400">*</span></label><select id="mArProject" class="input-field w-full rounded-lg px-4 py-2">' + projOpts + '</select></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">å®¢æˆ¶ <span class="text-red-400">*</span></label><select id="mArCustomer" class="input-field w-full rounded-lg px-4 py-2">' + custOpts + '</select></div>' +
                '</div>' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">é¡å‹</label><select id="mArType" class="input-field w-full rounded-lg px-4 py-2">' + typeOpts + '</select></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">é‡‘é¡ <span class="text-red-400">*</span></label><input type="number" id="mArAmount" class="input-field w-full rounded-lg px-4 py-2" value="' + (ar ? ar.amount : '') + '"></div>' +
                '</div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">é è¨ˆæ”¶æ¬¾æ—¥ <span class="text-red-400">*</span></label><input type="date" id="mArDueDate" class="input-field w-full rounded-lg px-4 py-2" value="' + (ar ? ar.dueDate : '') + '"></div>' +
                '<div class="flex justify-end gap-2 mt-6">' +
                '<button id="mArCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mArSave" class="btn-primary px-4 py-2 rounded-lg" data-id="' + (ar ? ar.id : '') + '">å„²å­˜</button>' +
                '</div></div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mArCancel').onclick = closeModal;
            $('mArSave').onclick = function() {
                var id = this.getAttribute('data-id');
                saveAr(id);
            };
        }

        function saveAr(editId) {
            var projects = getData('projects');
            var customers = getData('customers');
            if (customers.length === 0) customers = DEFAULT_CUSTOMERS;

            var projId = $('mArProject').value;
            var custCode = $('mArCustomer').value;
            var amount = parseFloat($('mArAmount').value) || 0;
            var dueDate = $('mArDueDate').value;

            if (!projId || !custCode || !amount || !dueDate) {
                toast('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }
            if (amount <= 0) {
                toast('é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
                return;
            }

            var project = null, customer = null;
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === projId) { project = projects[i]; break; }
            }
            for (var j = 0; j < customers.length; j++) {
                if (customers[j].code === custCode) { customer = customers[j]; break; }
            }

            if (!project) {
                toast('å°ˆæ¡ˆä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                return;
            }
            if (!customer) {
                toast('å®¢æˆ¶ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                return;
            }

            var arData = {
                id: editId || genId('ar'),
                projectId: project ? project.id : null,
                projectCode: project ? project.code : '',
                customerCode: customer ? customer.code : '',
                customerName: customer ? (customer.shortName || customer.name) : '',
                type: $('mArType').value,
                amount: amount,
                paidAmount: 0,
                dueDate: dueDate,
                createdAt: new Date().toISOString()
            };

            var arList = getData('ar');
            var oldProjectId = null;
            if (editId) {
                for (var k = 0; k < arList.length; k++) {
                    if (arList[k].id === editId) {
                        oldProjectId = arList[k].projectId;
                        arData.paidAmount = arList[k].paidAmount || 0;
                        arData.createdAt = arList[k].createdAt;
                        arList[k] = arData;
                        break;
                    }
                }
            } else {
                arList.push(arData);
            }

            setData('ar', arList);
            updateProjectCollectionRate(arData.projectId);
            if (oldProjectId && oldProjectId !== arData.projectId) {
                updateProjectCollectionRate(oldProjectId);
            }
            closeModal();
            loadArList();
            toast('å·²å„²å­˜', 'success');
        }

        function openPayArModal(id) {
            var arList = getData('ar');
            var ar = null;
            for (var i = 0; i < arList.length; i++) {
                if (arList[i].id === id) { ar = arList[i]; break; }
            }
            if (!ar) return;

            var remaining = ar.amount - (ar.paidAmount || 0);

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-md p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">è¨˜éŒ„æ”¶æ¬¾</h3>' +
                '<div class="mb-4 p-4 bg-slate-800 rounded-lg">' +
                '<p class="text-slate-400">å°ˆæ¡ˆï¼š<span class="text-white">' + (ar.projectCode||'-') + '</span></p>' +
                '<p class="text-slate-400">å¾…æ”¶ï¼š<span class="text-amber-400 mono">' + fmt(remaining) + '</span></p></div>' +
                '<div class="mb-4"><label class="block text-sm text-slate-400 mb-1">æœ¬æ¬¡æ”¶æ¬¾é‡‘é¡</label>' +
                '<input type="number" id="mPayAmount" class="input-field w-full rounded-lg px-4 py-2" value="' + remaining + '"></div>' +
                '<div class="flex justify-end gap-2">' +
                '<button id="mPayCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mPayConfirm" class="btn-primary px-4 py-2 rounded-lg" data-id="' + id + '">ç¢ºèªæ”¶æ¬¾</button>' +
                '</div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mPayCancel').onclick = closeModal;
            $('mPayConfirm').onclick = function() {
                var arId = this.getAttribute('data-id');
                var amount = parseFloat($('mPayAmount').value) || 0;
                if (amount <= 0) {
                    toast('æ”¶æ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
                    return;
                }
                var list = getData('ar');
                var projectId = null;
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id === arId) {
                        var currentRemaining = list[i].amount - (list[i].paidAmount || 0);
                        if (amount > currentRemaining) {
                            toast('æ”¶æ¬¾é‡‘é¡ä¸èƒ½è¶…éå¾…æ”¶é‡‘é¡ ' + fmt(currentRemaining), 'error');
                            return;
                        }
                        list[i].paidAmount = (list[i].paidAmount || 0) + amount;
                        projectId = list[i].projectId;
                        break;
                    }
                }
                setData('ar', list);
                if (projectId) updateProjectCollectionRate(projectId);
                closeModal();
                loadArList();
                toast('å·²æ”¶æ¬¾ ' + fmt(amount), 'success');
            };
        }

        function deleteAr(id) {
            var arList = getData('ar');
            var ar = null;
            for (var i = 0; i < arList.length; i++) {
                if (arList[i].id === id) { ar = arList[i]; break; }
            }
            if (!ar) return;
            confirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†æ‡‰æ”¶å¸³æ¬¾ï¼Ÿï¼ˆ' + (ar.projectCode||'') + ' ' + fmt(ar.amount) + 'ï¼‰', function() {
                var list = getData('ar');
                var projectId = null;
                var newList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id === id) {
                        projectId = list[i].projectId;
                    } else {
                        newList.push(list[i]);
                    }
                }
                setData('ar', newList);
                if (projectId) updateProjectCollectionRate(projectId);
                loadArList();
                toast('å·²åˆªé™¤', 'success');
            });
        }

        // ============== æ‡‰ä»˜å¸³æ¬¾ ==============
        function loadApList() {
            var apList = getData('ap');
            var searchVal = ($('apSearch') ? $('apSearch').value : '').toLowerCase();

            var checkTotal = 0, transferTotal = 0, cashTotal = 0;
            for (var i = 0; i < apList.length; i++) {
                var ap = apList[i];
                if (ap.status !== 'paid') {
                    if (ap.paymentType === 'CHECK') checkTotal += ap.amount || 0;
                    else if (ap.paymentType === 'TRANSFER') transferTotal += ap.amount || 0;
                    else if (ap.paymentType === 'CASH') cashTotal += ap.amount || 0;
                }
            }

            $('apCheck').textContent = fmt(checkTotal);
            $('apTransfer').textContent = fmt(transferTotal);
            $('apCash').textContent = fmt(cashTotal);

            var filtered = apList;
            if (searchVal) {
                filtered = apList.filter(function(ap) {
                    return (ap.projectCode||'').toLowerCase().indexOf(searchVal) >= 0 ||
                           (ap.vendorName||'').toLowerCase().indexOf(searchVal) >= 0 ||
                           (PM_TYPES[ap.paymentType]||ap.paymentType||'').toLowerCase().indexOf(searchVal) >= 0;
                });
            }

            var tbody = $('apTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">' + (searchVal ? 'ç„¡ç¬¦åˆæœå°‹çµæœ' : 'æš«ç„¡æ‡‰ä»˜å¸³æ¬¾') + '</td></tr>';
                return;
            }

            var html = '';
            for (var j = 0; j < filtered.length; j++) {
                var ap = filtered[j];
                var status = ap.status === 'paid' ? 'å·²ä»˜æ¬¾' : 'å¾…ä»˜æ¬¾';
                var statusCls = ap.status === 'paid' ? 'bg-green-500/20 text-green-300' : 'bg-amber-500/20 text-amber-300';

                html += '<tr class="border-t border-slate-700 hover:bg-slate-800/50">' +
                    '<td class="p-4">' + esc(PM_TYPES[ap.paymentType]||ap.paymentType) + '</td>' +
                    '<td class="p-4">' + esc(ap.projectCode||'-') + '</td>' +
                    '<td class="p-4">' + esc(ap.vendorName||'-') + '</td>' +
                    '<td class="p-4 text-right mono">' + fmt(ap.amount) + '</td>' +
                    '<td class="p-4">' + fmtDate(ap.dueDate) + '</td>' +
                    '<td class="p-4"><span class="px-2 py-1 rounded text-xs ' + statusCls + '">' + status + '</span></td>' +
                    '<td class="p-4">' +
                    '<button class="text-blue-400 mr-2" data-edit-ap="' + ap.id + '">ç·¨è¼¯</button>' +
                    (ap.status !== 'paid' ? '<button class="text-green-400 mr-2" data-pay-ap="' + ap.id + '">ä»˜æ¬¾</button>' : '') +
                    '<button class="text-red-400" data-delete-ap="' + ap.id + '">åˆªé™¤</button></td></tr>';
            }
            tbody.innerHTML = html;
        }

        function openApModal(editId) {
            var apList = getData('ap');
            var projects = getData('projects');
            var suppliers = getData('suppliers');

            var ap = null;
            if (editId) {
                for (var i = 0; i < apList.length; i++) {
                    if (apList[i].id === editId) { ap = apList[i]; break; }
                }
            }

            var projOpts = '<option value="">ç„¡</option>';
            for (var p = 0; p < projects.length; p++) {
                var sel = (ap && ap.projectId === projects[p].id) ? ' selected' : '';
                projOpts += '<option value="' + projects[p].id + '"' + sel + '>' + projects[p].code + '</option>';
            }

            var supOpts = '<option value="">é¸æ“‡ä¾›æ‡‰å•†</option>';
            for (var s = 0; s < suppliers.length; s++) {
                var ssel = (ap && ap.vendorCode === suppliers[s].code) ? ' selected' : '';
                supOpts += '<option value="' + suppliers[s].code + '"' + ssel + '>' + suppliers[s].name + '</option>';
            }

            var pmOpts = '';
            for (var t in PM_TYPES) {
                var tsel = (ap && ap.paymentType === t) ? ' selected' : '';
                pmOpts += '<option value="' + t + '"' + tsel + '>' + PM_TYPES[t] + '</option>';
            }

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-lg p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">' + (ap ? 'ç·¨è¼¯' : 'æ–°å¢') + 'æ‡‰ä»˜å¸³æ¬¾</h3>' +
                '<div class="space-y-4">' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">å°ˆæ¡ˆ</label><select id="mApProject" class="input-field w-full rounded-lg px-4 py-2">' + projOpts + '</select></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">ä¾›æ‡‰å•† <span class="text-red-400">*</span></label><select id="mApVendor" class="input-field w-full rounded-lg px-4 py-2">' + supOpts + '</select></div>' +
                '</div>' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">ä»˜æ¬¾æ–¹å¼</label><select id="mApType" class="input-field w-full rounded-lg px-4 py-2">' + pmOpts + '</select></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">é‡‘é¡ <span class="text-red-400">*</span></label><input type="number" id="mApAmount" class="input-field w-full rounded-lg px-4 py-2" value="' + (ap ? ap.amount : '') + '"></div>' +
                '</div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">åˆ°æœŸæ—¥ <span class="text-red-400">*</span></label><input type="date" id="mApDueDate" class="input-field w-full rounded-lg px-4 py-2" value="' + (ap ? ap.dueDate : '') + '"></div>' +
                '<div class="flex justify-end gap-2 mt-6">' +
                '<button id="mApCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mApSave" class="btn-primary px-4 py-2 rounded-lg" data-id="' + (ap ? ap.id : '') + '">å„²å­˜</button>' +
                '</div></div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mApCancel').onclick = closeModal;
            $('mApSave').onclick = function() {
                var id = this.getAttribute('data-id');
                saveAp(id);
            };
        }

        function saveAp(editId) {
            var projects = getData('projects');
            var suppliers = getData('suppliers');

            var projId = $('mApProject').value;
            var vendorCode = $('mApVendor').value;
            var amount = parseFloat($('mApAmount').value) || 0;
            var dueDate = $('mApDueDate').value;

            if (!vendorCode || !amount || !dueDate) {
                toast('è«‹å¡«å¯«ä¾›æ‡‰å•†ã€é‡‘é¡èˆ‡åˆ°æœŸæ—¥', 'error');
                return;
            }
            if (amount <= 0) {
                toast('é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
                return;
            }

            var project = null, vendor = null;
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === projId) { project = projects[i]; break; }
            }
            for (var j = 0; j < suppliers.length; j++) {
                if (suppliers[j].code === vendorCode) { vendor = suppliers[j]; break; }
            }

            if (!vendor) {
                toast('ä¾›æ‡‰å•†ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                return;
            }

            var apData = {
                id: editId || genId('ap'),
                projectId: project ? project.id : null,
                projectCode: project ? project.code : '',
                vendorCode: vendor ? vendor.code : '',
                vendorName: vendor ? vendor.name : '',
                paymentType: $('mApType').value,
                amount: amount,
                dueDate: dueDate,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            var apList = getData('ap');
            if (editId) {
                for (var k = 0; k < apList.length; k++) {
                    if (apList[k].id === editId) {
                        apData.status = apList[k].status;
                        apData.createdAt = apList[k].createdAt;
                        apList[k] = apData;
                        break;
                    }
                }
            } else {
                apList.push(apData);
            }

            setData('ap', apList);
            closeModal();
            loadApList();
            toast('å·²å„²å­˜', 'success');
        }

        function markApPaid(id) {
            var apList = getData('ap');
            for (var i = 0; i < apList.length; i++) {
                if (apList[i].id === id) {
                    apList[i].status = 'paid';
                    break;
                }
            }
            setData('ap', apList);
            loadApList();
            toast('å·²æ¨™è¨˜ä»˜æ¬¾', 'success');
        }

        function deleteAp(id) {
            var apList = getData('ap');
            var ap = null;
            for (var i = 0; i < apList.length; i++) {
                if (apList[i].id === id) { ap = apList[i]; break; }
            }
            if (!ap) return;
            confirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†æ‡‰ä»˜å¸³æ¬¾ï¼Ÿï¼ˆ' + (ap.projectCode||'') + ' ' + fmt(ap.amount) + 'ï¼‰', function() {
                var list = getData('ap');
                var newList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id !== id) newList.push(list[i]);
                }
                setData('ap', newList);
                loadApList();
                toast('å·²åˆªé™¤', 'success');
            });
        }

        // ============== å·¥ç¨‹å°ˆæ¡ˆ ==============
        function loadProjectList() {
            var projects = getData('projects');
            var searchVal = ($('projectSearch') ? $('projectSearch').value : '').toLowerCase();
            var container = $('projectList');

            var filtered = projects;
            if (searchVal) {
                filtered = projects.filter(function(p) {
                    return (p.code||'').toLowerCase().indexOf(searchVal) >= 0 ||
                           (p.name||'').toLowerCase().indexOf(searchVal) >= 0 ||
                           (p.customerName||'').toLowerCase().indexOf(searchVal) >= 0;
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="data-table rounded-xl p-8 text-center text-slate-400">' + (searchVal ? 'ç„¡ç¬¦åˆæœå°‹çµæœ' : 'æš«ç„¡å°ˆæ¡ˆï¼Œé»æ“Šã€Œæ–°å¢å°ˆæ¡ˆã€å»ºç«‹') + '</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < filtered.length; i++) {
                var p = filtered[i];
                var cost = ((p.materialCost||0) + (p.laborCost||0)) * FACTOR;
                var bonus = (p.orderAmount||0) - (p.commission||0) - cost;
                var rate = p.collectionRate || 0;

                var statusLabels = {ongoing:'é€²è¡Œä¸­', completed:'å·²å®Œå·¥', closed:'å·²çµæ¡ˆ'};
                var statusColors = {ongoing:'bg-blue-500/20 text-blue-300', completed:'bg-green-500/20 text-green-300', closed:'bg-slate-500/20 text-slate-300'};
                var pStatus = p.status || 'ongoing';

                html += '<div class="data-table rounded-xl overflow-hidden">' +
                    '<div class="p-4 border-b border-slate-700 flex justify-between items-center">' +
                    '<div class="flex items-center gap-3"><span class="text-2xl">ğŸ—ï¸</span><div><h4 class="font-bold">' + esc(p.code) + '</h4><p class="text-sm text-slate-400">' + esc(p.name) + '</p></div></div>' +
                    '<div class="flex items-center gap-4">' +
                    '<span class="px-3 py-1 rounded-full text-xs ' + statusColors[pStatus] + '">' + statusLabels[pStatus] + '</span>' +
                    '<span class="px-3 py-1 rounded-full text-xs ' + (rate >= 80 ? 'bg-green-500/20 text-green-300' : 'bg-amber-500/20 text-amber-300') + '">æ”¶æ¬¾ ' + rate.toFixed(1) + '%</span>' +
                    '<button class="text-blue-400" data-edit-project="' + p.id + '">ç·¨è¼¯</button>' +
                    '<button class="text-red-400" data-delete-project="' + p.id + '">åˆªé™¤</button></div></div>' +
                    '<div class="p-4 grid grid-cols-5 gap-4">' +
                    '<div><p class="text-xs text-slate-400">å®¢æˆ¶</p><p>' + esc(p.customerName||'-') + '</p></div>' +
                    '<div><p class="text-xs text-slate-400">è¨‚å–®é‡‘é¡</p><p class="mono">' + fmt(p.orderAmount) + '</p></div>' +
                    '<div><p class="text-xs text-slate-400">ä½£é‡‘</p><p class="mono text-red-400">' + fmt(p.commission||0) + '</p></div>' +
                    '<div><p class="text-xs text-slate-400">æˆæœ¬Ã—1.15</p><p class="mono text-amber-400">' + fmt(cost) + '</p></div>' +
                    '<div><p class="text-xs text-slate-400">çé‡‘</p><p class="mono ' + (bonus >= 0 ? 'text-green-400' : 'text-red-400') + '">' + fmt(bonus) + '</p></div>' +
                    '</div></div>';
            }
            container.innerHTML = html;
        }

        function openProjectModal(editId) {
            var projects = getData('projects');
            var customers = getData('customers');
            if (customers.length === 0) customers = DEFAULT_CUSTOMERS;

            var project = null;
            if (editId) {
                for (var i = 0; i < projects.length; i++) {
                    if (projects[i].id === editId) { project = projects[i]; break; }
                }
            }

            var custOpts = '<option value="">é¸æ“‡å®¢æˆ¶</option>';
            for (var c = 0; c < customers.length; c++) {
                var sel = (project && project.customerCode === customers[c].code) ? ' selected' : '';
                custOpts += '<option value="' + customers[c].code + '"' + sel + '>' + (customers[c].shortName||customers[c].name) + '</option>';
            }

            var code = project ? project.code : 'ZT-' + new Date().getFullYear() + '-' + String(projects.length + 1).padStart(3, '0');

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-2xl p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">' + (project ? 'ç·¨è¼¯' : 'æ–°å¢') + 'å·¥ç¨‹å°ˆæ¡ˆ</h3>' +
                '<div class="space-y-4">' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">å°ˆæ¡ˆä»£è™Ÿ <span class="text-red-400">*</span></label><input type="text" id="mProjCode" class="input-field w-full rounded-lg px-4 py-2" value="' + escAttr(code) + '"></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">å®¢æˆ¶ <span class="text-red-400">*</span></label><select id="mProjCustomer" class="input-field w-full rounded-lg px-4 py-2">' + custOpts + '</select></div>' +
                '</div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">å°ˆæ¡ˆåç¨± <span class="text-red-400">*</span></label><input type="text" id="mProjName" class="input-field w-full rounded-lg px-4 py-2" value="' + escAttr(project ? project.name : '') + '"></div>' +
                '<div class="grid grid-cols-3 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">è¨‚å–®é‡‘é¡ <span class="text-red-400">*</span></label><input type="number" id="mProjOrder" class="input-field w-full rounded-lg px-4 py-2" value="' + (project ? project.orderAmount : '') + '"></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">ææ–™è²»</label><input type="number" id="mProjMaterial" class="input-field w-full rounded-lg px-4 py-2" value="' + (project ? project.materialCost||0 : 0) + '"></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">äººå·¥è²»</label><input type="number" id="mProjLabor" class="input-field w-full rounded-lg px-4 py-2" value="' + (project ? project.laborCost||0 : 0) + '"></div>' +
                '</div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">å°ˆæ¡ˆç‹€æ…‹</label><select id="mProjStatus" class="input-field w-full rounded-lg px-4 py-2">' +
                '<option value="ongoing"' + (project && project.status === 'ongoing' ? ' selected' : (!project ? ' selected' : '')) + '>é€²è¡Œä¸­</option>' +
                '<option value="completed"' + (project && project.status === 'completed' ? ' selected' : '') + '>å·²å®Œå·¥</option>' +
                '<option value="closed"' + (project && project.status === 'closed' ? ' selected' : '') + '>å·²çµæ¡ˆ</option>' +
                '</select></div>' +
                '<div class="flex justify-end gap-2 mt-6">' +
                '<button id="mProjCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mProjSave" class="btn-primary px-4 py-2 rounded-lg" data-id="' + (project ? project.id : '') + '">å„²å­˜</button>' +
                '</div></div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mProjCancel').onclick = closeModal;
            $('mProjSave').onclick = function() {
                var id = this.getAttribute('data-id');
                saveProject(id);
            };
        }

        function saveProject(editId) {
            var customers = getData('customers');
            if (customers.length === 0) customers = DEFAULT_CUSTOMERS;

            var custCode = $('mProjCustomer').value;
            var projCode = $('mProjCode').value;
            var projName = $('mProjName').value;
            var orderAmount = parseFloat($('mProjOrder').value) || 0;

            if (!projCode || !projName || !orderAmount) {
                toast('è«‹å¡«å¯«å°ˆæ¡ˆä»£è™Ÿã€åç¨±èˆ‡è¨‚å–®é‡‘é¡', 'error');
                return;
            }
            if (orderAmount <= 0) {
                toast('è¨‚å–®é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
                return;
            }

            var customer = null;
            for (var i = 0; i < customers.length; i++) {
                if (customers[i].code === custCode) { customer = customers[i]; break; }
            }

            var projData = {
                id: editId || genId('pj'),
                code: projCode,
                name: projName,
                customerCode: customer ? customer.code : '',
                customerName: customer ? (customer.shortName || customer.name) : '',
                orderAmount: orderAmount,
                materialCost: parseFloat($('mProjMaterial').value) || 0,
                laborCost: parseFloat($('mProjLabor').value) || 0,
                status: $('mProjStatus').value || 'ongoing',
                commission: 0,
                collectionRate: 0,
                bonusStatus: 'pending',
                bonusPaidDate: null,
                createdAt: new Date().toISOString()
            };

            var projects = getData('projects');
            if (editId) {
                for (var j = 0; j < projects.length; j++) {
                    if (projects[j].id === editId) {
                        projData.commission = projects[j].commission || 0;
                        projData.collectionRate = projects[j].collectionRate || 0;
                        projData.bonusStatus = projects[j].bonusStatus || 'pending';
                        projData.bonusPaidDate = projects[j].bonusPaidDate || null;
                        projData.createdAt = projects[j].createdAt;
                        projects[j] = projData;
                        break;
                    }
                }
            } else {
                projects.push(projData);
            }

            setData('projects', projects);
            closeModal();
            loadProjectList();
            toast('å·²å„²å­˜', 'success');
        }

        function deleteProject(id) {
            var projects = getData('projects');
            var project = null;
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === id) { project = projects[i]; break; }
            }
            if (!project) return;
            confirmDialog('ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆã€Œ' + project.code + ' ' + project.name + 'ã€ï¼Ÿç›¸é—œæ‡‰æ”¶ã€æ‡‰ä»˜ã€ä½£é‡‘ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚', function() {
                var list = getData('projects');
                var newList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id !== id) newList.push(list[i]);
                }
                setData('projects', newList);
                // Also remove related commissions
                var commList = getData('commissions');
                var newComm = [];
                for (var j = 0; j < commList.length; j++) {
                    if (commList[j].projectId !== id) newComm.push(commList[j]);
                }
                setData('commissions', newComm);
                // Also remove related AR records
                var arList = getData('ar');
                var newAr = [];
                for (var a = 0; a < arList.length; a++) {
                    if (arList[a].projectId !== id) newAr.push(arList[a]);
                }
                setData('ar', newAr);
                // Also remove related AP records
                var apList = getData('ap');
                var newAp = [];
                for (var b = 0; b < apList.length; b++) {
                    if (apList[b].projectId !== id) newAp.push(apList[b]);
                }
                setData('ap', newAp);
                loadProjectList();
                toast('å·²åˆªé™¤å°ˆæ¡ˆåŠç›¸é—œè¨˜éŒ„', 'success');
            });
        }

        // ============== ä½£é‡‘ç®¡ç† ==============
        function loadCommissionList() {
            var commList = getData('commissions');
            var searchTerm = ($('commSearch') ? $('commSearch').value : '').toLowerCase();

            var agentTotal = 0, referralTotal = 0, rebateTotal = 0;
            for (var i = 0; i < commList.length; i++) {
                var c = commList[i];
                if (c.type === 'agent') agentTotal += c.amount || 0;
                else if (c.type === 'referral') referralTotal += c.amount || 0;
                else if (c.type === 'rebate') rebateTotal += c.amount || 0;
            }
            $('commAgent').textContent = fmt(agentTotal);
            $('commReferral').textContent = fmt(referralTotal);
            $('commRebate').textContent = fmt(rebateTotal);

            // Apply search filter
            var filtered = commList;
            if (searchTerm) {
                filtered = [];
                for (var f = 0; f < commList.length; f++) {
                    var fc = commList[f];
                    var typeName = COMM_TYPES[fc.type] || fc.type || '';
                    if ((fc.projectCode || '').toLowerCase().indexOf(searchTerm) >= 0 ||
                        typeName.toLowerCase().indexOf(searchTerm) >= 0 ||
                        (fc.description || '').toLowerCase().indexOf(searchTerm) >= 0) {
                        filtered.push(fc);
                    }
                }
            }

            var tbody = $('commTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">' + (searchTerm ? 'ç„¡ç¬¦åˆæœå°‹çµæœ' : 'æš«ç„¡ä½£é‡‘è¨˜éŒ„ï¼Œé»æ“Šã€Œæ–°å¢ä½£é‡‘ã€å»ºç«‹') + '</td></tr>';
                return;
            }

            var html = '';
            for (var j = 0; j < filtered.length; j++) {
                var comm = filtered[j];
                html += '<tr class="border-t border-slate-700 hover:bg-slate-800/50">' +
                    '<td class="p-4">' + esc(comm.projectCode||'-') + '</td>' +
                    '<td class="p-4"><span class="px-2 py-1 rounded text-xs ' +
                    (comm.type === 'agent' ? 'bg-blue-500/20 text-blue-300' : comm.type === 'referral' ? 'bg-purple-500/20 text-purple-300' : 'bg-amber-500/20 text-amber-300') +
                    '">' + (COMM_TYPES[comm.type]||comm.type) + '</span></td>' +
                    '<td class="p-4">' + esc(comm.description||'-') + '</td>' +
                    '<td class="p-4 text-right mono text-red-400">' + fmt(comm.amount) + '</td>' +
                    '<td class="p-4">' + fmtDate(comm.date) + '</td>' +
                    '<td class="p-4">' +
                    '<button class="text-blue-400 mr-2" data-edit-comm="' + comm.id + '">ç·¨è¼¯</button>' +
                    '<button class="text-red-400" data-delete-comm="' + comm.id + '">åˆªé™¤</button></td></tr>';
            }
            tbody.innerHTML = html;
        }

        function openCommissionModal(editId) {
            var commList = getData('commissions');
            var projects = getData('projects');

            var comm = null;
            if (editId) {
                for (var i = 0; i < commList.length; i++) {
                    if (commList[i].id === editId) { comm = commList[i]; break; }
                }
            }

            var projOpts = '<option value="">é¸æ“‡å°ˆæ¡ˆ</option>';
            for (var p = 0; p < projects.length; p++) {
                var sel = (comm && comm.projectId === projects[p].id) ? ' selected' : '';
                projOpts += '<option value="' + projects[p].id + '"' + sel + '>' + projects[p].code + ' - ' + projects[p].name + '</option>';
            }

            var typeOpts = '';
            for (var t in COMM_TYPES) {
                var tsel = (comm && comm.type === t) ? ' selected' : '';
                typeOpts += '<option value="' + t + '"' + tsel + '>' + COMM_TYPES[t] + '</option>';
            }

            var today = new Date().toISOString().split('T')[0];

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-lg p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">' + (comm ? 'ç·¨è¼¯' : 'æ–°å¢') + 'ä½£é‡‘</h3>' +
                '<div class="space-y-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">å°ˆæ¡ˆ <span class="text-red-400">*</span></label><select id="mCommProject" class="input-field w-full rounded-lg px-4 py-2">' + projOpts + '</select></div>' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">é¡å‹</label><select id="mCommType" class="input-field w-full rounded-lg px-4 py-2">' + typeOpts + '</select></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">é‡‘é¡ <span class="text-red-400">*</span></label><input type="number" id="mCommAmount" class="input-field w-full rounded-lg px-4 py-2" value="' + (comm ? comm.amount : '') + '"></div>' +
                '</div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">èªªæ˜</label><input type="text" id="mCommDesc" class="input-field w-full rounded-lg px-4 py-2" value="' + escAttr(comm ? (comm.description||'') : '') + '"></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">æ—¥æœŸ</label><input type="date" id="mCommDate" class="input-field w-full rounded-lg px-4 py-2" value="' + (comm ? comm.date : today) + '"></div>' +
                '<div class="flex justify-end gap-2 mt-6">' +
                '<button id="mCommCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mCommSave" class="btn-primary px-4 py-2 rounded-lg" data-id="' + (comm ? comm.id : '') + '">å„²å­˜</button>' +
                '</div></div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mCommCancel').onclick = closeModal;
            $('mCommSave').onclick = function() {
                var id = this.getAttribute('data-id');
                saveCommission(id);
            };
        }

        function saveCommission(editId) {
            var projects = getData('projects');
            var projId = $('mCommProject').value;
            var amount = parseFloat($('mCommAmount').value) || 0;

            if (!projId || !amount) {
                toast('è«‹é¸æ“‡å°ˆæ¡ˆä¸¦å¡«å¯«é‡‘é¡', 'error');
                return;
            }
            if (amount <= 0) {
                toast('é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
                return;
            }

            var project = null;
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === projId) { project = projects[i]; break; }
            }

            var commData = {
                id: editId || genId('cm'),
                projectId: project ? project.id : null,
                projectCode: project ? project.code : '',
                type: $('mCommType').value,
                amount: amount,
                description: $('mCommDesc').value,
                date: $('mCommDate').value,
                createdAt: new Date().toISOString()
            };

            var commList = getData('commissions');
            var oldProjectId = null;
            if (editId) {
                for (var k = 0; k < commList.length; k++) {
                    if (commList[k].id === editId) {
                        oldProjectId = commList[k].projectId;
                        commData.createdAt = commList[k].createdAt;
                        commList[k] = commData;
                        break;
                    }
                }
            } else {
                commList.push(commData);
            }

            setData('commissions', commList);
            updateProjectCommission(commData.projectId);
            if (oldProjectId && oldProjectId !== commData.projectId) {
                updateProjectCommission(oldProjectId);
            }
            closeModal();
            loadCommissionList();
            toast('å·²å„²å­˜ä½£é‡‘', 'success');
        }

        function deleteCommission(id) {
            var commList = getData('commissions');
            var comm = null;
            for (var i = 0; i < commList.length; i++) {
                if (commList[i].id === id) { comm = commList[i]; break; }
            }
            if (!comm) return;
            confirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†ä½£é‡‘ï¼Ÿï¼ˆ' + (comm.projectCode||'') + ' ' + fmt(comm.amount) + 'ï¼‰', function() {
                var list = getData('commissions');
                var projectId = null;
                var newList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id === id) {
                        projectId = list[i].projectId;
                    } else {
                        newList.push(list[i]);
                    }
                }
                setData('commissions', newList);
                if (projectId) updateProjectCommission(projectId);
                loadCommissionList();
                toast('å·²åˆªé™¤ä½£é‡‘', 'success');
            });
        }

        // ============== çé‡‘çµç®— ==============
        function loadBonusList() {
            var projects = getData('projects');
            var tbody = $('bonusTableBody');

            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400">æš«ç„¡å°ˆæ¡ˆè³‡æ–™</td></tr>';
                return;
            }

            var html = '';
            for (var i = 0; i < projects.length; i++) {
                var p = projects[i];
                var cost = ((p.materialCost||0) + (p.laborCost||0)) * FACTOR;
                var bonus = (p.orderAmount||0) - (p.commission||0) - cost;
                var rate = p.collectionRate || 0;
                var eligible = rate >= THRESHOLD && bonus > 0;
                var bonusStatus = p.bonusStatus || 'pending';
                var isPaid = bonusStatus === 'paid';

                var statusHtml = '';
                if (isPaid) {
                    statusHtml = '<span class="text-blue-400">âœ“ å·²ç™¼æ”¾</span>' + (p.bonusPaidDate ? '<div class="text-xs text-slate-400">' + fmtDate(p.bonusPaidDate) + '</div>' : '');
                } else if (eligible) {
                    statusHtml = '<span class="text-green-400">âœ“ å¯ç™¼æ”¾</span>';
                } else {
                    statusHtml = '<span class="text-slate-400">æœªé”æ¨™</span>';
                }

                var actionHtml = '';
                if (isPaid) {
                    actionHtml = '<button class="text-amber-400 text-sm" data-cancel-bonus="' + p.id + '">å–æ¶ˆç™¼æ”¾</button>';
                } else if (eligible) {
                    actionHtml = '<button class="btn-primary text-sm px-3 py-1 rounded" data-pay-bonus="' + p.id + '">ç™¼æ”¾çé‡‘</button>';
                } else {
                    actionHtml = '<span class="text-slate-500">-</span>';
                }

                html += '<tr class="border-t border-slate-700">' +
                    '<td class="p-4"><div class="font-medium">' + esc(p.code) + '</div><div class="text-xs text-slate-400">' + esc(p.name) + '</div></td>' +
                    '<td class="p-4 text-right mono">' + fmt(p.orderAmount) + '</td>' +
                    '<td class="p-4 text-right mono text-red-400">' + fmt(p.commission||0) + '</td>' +
                    '<td class="p-4 text-right mono text-amber-400">' + fmt(cost) + '</td>' +
                    '<td class="p-4 text-right mono ' + (bonus >= 0 ? 'text-green-400' : 'text-red-400') + '">' + fmt(bonus) + '</td>' +
                    '<td class="p-4 text-center"><span class="px-2 py-1 rounded ' + (rate >= THRESHOLD ? 'bg-green-500/20 text-green-300' : 'bg-amber-500/20 text-amber-300') + '">' + rate.toFixed(1) + '%</span></td>' +
                    '<td class="p-4">' + statusHtml + '</td>' +
                    '<td class="p-4">' + actionHtml + '</td>' +
                    '</tr>';
            }
            tbody.innerHTML = html;
        }

        function markBonusPaid(projectId) {
            var projects = getData('projects');
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === projectId) {
                    projects[i].bonusStatus = 'paid';
                    projects[i].bonusPaidDate = new Date().toISOString();
                    break;
                }
            }
            setData('projects', projects);
            loadBonusList();
            loadDashboard();
            toast('å·²æ¨™è¨˜çé‡‘ç™¼æ”¾', 'success');
        }

        function cancelBonusPaid(projectId) {
            confirmDialog('ç¢ºå®šè¦å–æ¶ˆæ­¤çé‡‘çš„ç™¼æ”¾ç‹€æ…‹ï¼Ÿ', function() {
                var projects = getData('projects');
                for (var i = 0; i < projects.length; i++) {
                    if (projects[i].id === projectId) {
                        projects[i].bonusStatus = 'pending';
                        projects[i].bonusPaidDate = null;
                        break;
                    }
                }
                setData('projects', projects);
                loadBonusList();
                loadDashboard();
                toast('å·²å–æ¶ˆçé‡‘ç™¼æ”¾', 'success');
            });
        }

        // ============== è¨­å®š ==============
        function loadSettings() {
            // Load company info from LocalStorage
            var company = getObj('company');
            if (company.name !== undefined) $('companyName').value = company.name;
            if (company.contact !== undefined) $('companyContact').value = company.contact;
            if (company.phone !== undefined) $('companyPhone').value = company.phone;

            var customers = getData('customers');
            if (customers.length === 0) {
                customers = DEFAULT_CUSTOMERS;
                setData('customers', customers);
            }

            var custHtml = '';
            for (var i = 0; i < customers.length; i++) {
                var c = customers[i];
                custHtml += '<div class="flex justify-between items-center py-2 border-b border-slate-700"><span>' + esc(c.code) + ' - ' + esc(c.name) + '</span><div>' +
                    '<button class="text-blue-400 text-sm mr-2" data-edit-customer="' + c.code + '">ç·¨è¼¯</button>' +
                    '<button class="text-red-400 text-sm" data-delete-customer="' + c.code + '">åˆªé™¤</button></div></div>';
            }
            $('customerList').innerHTML = custHtml || '<p class="text-slate-400">ç„¡å®¢æˆ¶è³‡æ–™</p>';

            var suppliers = getData('suppliers');
            var supHtml = '';
            for (var j = 0; j < suppliers.length; j++) {
                var s = suppliers[j];
                supHtml += '<div class="flex justify-between items-center py-2 border-b border-slate-700"><span>' + esc(s.code) + ' - ' + esc(s.name) + '</span><div>' +
                    '<button class="text-blue-400 text-sm mr-2" data-edit-supplier="' + s.code + '">ç·¨è¼¯</button>' +
                    '<button class="text-red-400 text-sm" data-delete-supplier="' + s.code + '">åˆªé™¤</button></div></div>';
            }
            $('supplierList').innerHTML = supHtml || '<p class="text-slate-400">ç„¡ä¾›æ‡‰å•†è³‡æ–™ï¼Œè«‹æ–°å¢</p>';
        }

        function saveCompanySettings() {
            var company = {
                name: $('companyName').value,
                contact: $('companyContact').value,
                phone: $('companyPhone').value
            };
            setObj('company', company);
            toast('å…¬å¸è³‡è¨Šå·²å„²å­˜', 'success');
        }

        function openCustomerModal(editCode) {
            var customers = getData('customers');
            var cust = null;
            if (editCode) {
                for (var i = 0; i < customers.length; i++) {
                    if (customers[i].code === editCode) { cust = customers[i]; break; }
                }
            }

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-md p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">' + (cust ? 'ç·¨è¼¯' : 'æ–°å¢') + 'å®¢æˆ¶</h3>' +
                '<div class="space-y-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">ä»£ç¢¼</label><input type="text" id="mCustCode" class="input-field w-full rounded-lg px-4 py-2" value="' + (cust ? cust.code : 'C' + String(customers.length + 1).padStart(3, '0')) + '"' + (cust ? ' readonly' : '') + '></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">åç¨±</label><input type="text" id="mCustName" class="input-field w-full rounded-lg px-4 py-2" value="' + escAttr(cust ? cust.name : '') + '"></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">ç°¡ç¨±</label><input type="text" id="mCustShort" class="input-field w-full rounded-lg px-4 py-2" value="' + escAttr(cust ? cust.shortName||'' : '') + '"></div>' +
                '<div class="flex justify-end gap-2 mt-6">' +
                '<button id="mCustCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mCustSave" class="btn-primary px-4 py-2 rounded-lg" data-code="' + (cust ? cust.code : '') + '">å„²å­˜</button>' +
                '</div></div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mCustCancel').onclick = closeModal;
            $('mCustSave').onclick = function() {
                var code = this.getAttribute('data-code');
                var custData = {
                    code: $('mCustCode').value,
                    name: $('mCustName').value,
                    shortName: $('mCustShort').value
                };
                var list = getData('customers');
                if (code) {
                    for (var i = 0; i < list.length; i++) {
                        if (list[i].code === code) { list[i] = custData; break; }
                    }
                } else {
                    list.push(custData);
                }
                setData('customers', list);
                closeModal();
                loadSettings();
                toast('å·²å„²å­˜', 'success');
            };
        }

        function deleteCustomer(code) {
            confirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿç›¸é—œæ‡‰æ”¶å¸³æ¬¾ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚ï¼ˆä»£ç¢¼ï¼š' + code + 'ï¼‰', function() {
                var list = getData('customers');
                var newList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].code !== code) newList.push(list[i]);
                }
                setData('customers', newList);
                // Also remove related AR records and update affected project collection rates
                var arList = getData('ar');
                var newAr = [];
                var affectedProjects = {};
                for (var j = 0; j < arList.length; j++) {
                    if (arList[j].customerCode !== code) {
                        newAr.push(arList[j]);
                    } else if (arList[j].projectId) {
                        affectedProjects[arList[j].projectId] = true;
                    }
                }
                setData('ar', newAr);
                // Update collection rates for affected projects
                for (var pid in affectedProjects) {
                    updateProjectCollectionRate(pid);
                }
                loadSettings();
                toast('å·²åˆªé™¤å®¢æˆ¶åŠç›¸é—œè¨˜éŒ„', 'success');
            });
        }

        function openSupplierModal(editCode) {
            var suppliers = getData('suppliers');
            var sup = null;
            if (editCode) {
                for (var i = 0; i < suppliers.length; i++) {
                    if (suppliers[i].code === editCode) { sup = suppliers[i]; break; }
                }
            }

            var html = '<div class="fixed inset-0 modal-overlay flex items-center justify-center z-50">' +
                '<div class="modal-content rounded-xl w-full max-w-md p-6 m-4">' +
                '<h3 class="text-xl font-bold mb-6">' + (sup ? 'ç·¨è¼¯' : 'æ–°å¢') + 'ä¾›æ‡‰å•†</h3>' +
                '<div class="space-y-4">' +
                '<div><label class="block text-sm text-slate-400 mb-1">ä»£ç¢¼</label><input type="text" id="mSupCode" class="input-field w-full rounded-lg px-4 py-2" value="' + (sup ? sup.code : 'V' + String(suppliers.length + 1).padStart(3, '0')) + '"' + (sup ? ' readonly' : '') + '></div>' +
                '<div><label class="block text-sm text-slate-400 mb-1">åç¨±</label><input type="text" id="mSupName" class="input-field w-full rounded-lg px-4 py-2" value="' + escAttr(sup ? sup.name : '') + '"></div>' +
                '<div class="flex justify-end gap-2 mt-6">' +
                '<button id="mSupCancel" class="px-4 py-2 rounded-lg bg-slate-700">å–æ¶ˆ</button>' +
                '<button id="mSupSave" class="btn-primary px-4 py-2 rounded-lg" data-code="' + (sup ? sup.code : '') + '">å„²å­˜</button>' +
                '</div></div></div></div>';

            $('modalContainer').innerHTML = html;
            $('mSupCancel').onclick = closeModal;
            $('mSupSave').onclick = function() {
                var code = this.getAttribute('data-code');
                var supData = {
                    code: $('mSupCode').value,
                    name: $('mSupName').value
                };
                var list = getData('suppliers');
                if (code) {
                    for (var i = 0; i < list.length; i++) {
                        if (list[i].code === code) { list[i] = supData; break; }
                    }
                } else {
                    list.push(supData);
                }
                setData('suppliers', list);
                closeModal();
                loadSettings();
                toast('å·²å„²å­˜', 'success');
            };
        }

        function deleteSupplier(code) {
            confirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤ä¾›æ‡‰å•†ï¼Ÿç›¸é—œæ‡‰ä»˜å¸³æ¬¾ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚ï¼ˆä»£ç¢¼ï¼š' + code + 'ï¼‰', function() {
                var list = getData('suppliers');
                var newList = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].code !== code) newList.push(list[i]);
                }
                setData('suppliers', newList);
                // Also remove related AP records
                var apList = getData('ap');
                var newAp = [];
                for (var j = 0; j < apList.length; j++) {
                    if (apList[j].vendorCode !== code) newAp.push(apList[j]);
                }
                setData('ap', newAp);
                loadSettings();
                toast('å·²åˆªé™¤ä¾›æ‡‰å•†åŠç›¸é—œè¨˜éŒ„', 'success');
            });
        }

        // ============== è³‡æ–™å‚™ä»½ ==============
        function loadBackupPage() {
            var stats = '';
            var keys = ['ar', 'ap', 'projects', 'commissions', 'customers', 'suppliers'];
            var labels = {'ar':'æ‡‰æ”¶å¸³æ¬¾', 'ap':'æ‡‰ä»˜å¸³æ¬¾', 'projects':'å·¥ç¨‹å°ˆæ¡ˆ', 'commissions':'ä½£é‡‘è¨˜éŒ„', 'customers':'å®¢æˆ¶', 'suppliers':'ä¾›æ‡‰å•†'};
            for (var i = 0; i < keys.length; i++) {
                var data = getData(keys[i]);
                stats += '<p class="text-slate-400">' + labels[keys[i]] + 'ï¼š<span class="text-white">' + data.length + ' ç­†</span></p>';
            }
            $('exportStats').innerHTML = stats;
        }

        function exportData() {
            var keys = ['ar', 'ap', 'projects', 'commissions', 'customers', 'suppliers', 'company'];
            var exportObj = { version: VERSION, exportDate: new Date().toISOString(), data: {} };
            for (var i = 0; i < keys.length; i++) {
                var raw = localStorage.getItem('zt_' + keys[i]);
                if (raw) {
                    try { exportObj.data[keys[i]] = JSON.parse(raw); }
                    catch(e) { /* skip */ }
                }
            }
            var blob = new Blob([JSON.stringify(exportObj, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'æ™ºéµè²¡å‹™å‚™ä»½_' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            toast('å·²åŒ¯å‡ºå‚™ä»½æª”æ¡ˆ', 'success');
        }

        var pendingImportData = null;

        function handleImportFile(e) {
            var file = e.target.files[0];
            if (!file) return;
            $('importFileLabel').textContent = file.name;
            var reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    var data = JSON.parse(ev.target.result);
                    // Validate basic structure
                    if (!data.data || typeof data.data !== 'object') {
                        toast('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ï¼šç¼ºå°‘ data æ¬„ä½', 'error');
                        return;
                    }
                    // Validate data arrays are actually arrays
                    var arrayKeys = ['ar', 'ap', 'projects', 'commissions', 'customers', 'suppliers'];
                    for (var v = 0; v < arrayKeys.length; v++) {
                        var k = arrayKeys[v];
                        if (data.data[k] !== undefined && !Array.isArray(data.data[k])) {
                            toast('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ï¼š' + k + ' å¿…é ˆæ˜¯é™£åˆ—', 'error');
                            return;
                        }
                    }
                    // Validate company is object if exists
                    if (data.data.company !== undefined && (typeof data.data.company !== 'object' || Array.isArray(data.data.company))) {
                        toast('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ï¼šcompany å¿…é ˆæ˜¯ç‰©ä»¶', 'error');
                        return;
                    }
                    pendingImportData = data;
                    var preview = $('importPreview');
                    var labels = {'ar':'æ‡‰æ”¶å¸³æ¬¾', 'ap':'æ‡‰ä»˜å¸³æ¬¾', 'projects':'å·¥ç¨‹å°ˆæ¡ˆ', 'commissions':'ä½£é‡‘è¨˜éŒ„', 'customers':'å®¢æˆ¶', 'suppliers':'ä¾›æ‡‰å•†'};
                    var html = '<p class="font-bold text-white mb-2">æª”æ¡ˆé è¦½ï¼š</p>';
                    html += '<p class="text-slate-400">ç‰ˆæœ¬ï¼š<span class="text-white">' + (data.version||'æœªçŸ¥') + '</span></p>';
                    html += '<p class="text-slate-400">åŒ¯å‡ºæ—¥æœŸï¼š<span class="text-white">' + fmtDate(data.exportDate) + '</span></p>';
                    for (var key in labels) {
                        var arr = data.data[key];
                        if (arr) {
                            html += '<p class="text-slate-400">' + labels[key] + 'ï¼š<span class="text-white">' + (Array.isArray(arr) ? arr.length : 1) + ' ç­†</span></p>';
                        }
                    }
                    preview.innerHTML = html;
                    preview.classList.remove('hidden');
                    $('btnImport').disabled = false;
                } catch(err) {
                    toast('æª”æ¡ˆè§£æå¤±æ•—ï¼š' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function importData() {
            if (!pendingImportData || !pendingImportData.data) {
                toast('ç„¡è³‡æ–™å¯åŒ¯å…¥', 'error');
                return;
            }
            confirmDialog('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™ï¼Ÿé€™å°‡è¦†è“‹æ‰€æœ‰ç¾æœ‰è³‡æ–™ï¼', function() {
                var data = pendingImportData.data;
                var keys = ['ar', 'ap', 'projects', 'commissions', 'customers', 'suppliers', 'company'];
                for (var i = 0; i < keys.length; i++) {
                    if (data[keys[i]] !== undefined) {
                        localStorage.setItem('zt_' + keys[i], JSON.stringify(data[keys[i]]));
                    }
                }
                pendingImportData = null;
                $('importPreview').classList.add('hidden');
                $('btnImport').disabled = true;
                $('importFileLabel').textContent = 'é»æ“Šé¸æ“‡ JSON æª”æ¡ˆ';
                $('importFile').value = '';
                loadBackupPage();
                toast('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼', 'success');
            });
        }

        // ============== CSV åŒ¯å…¥åŠŸèƒ½ ==============
        var pendingCsvData = {customers:null, suppliers:null, projects:null, ar:null, ap:null, commissions:null};

        function parseCSV(text) {
            var lines = text.split(/\r?\n/).filter(function(l) { return l.trim(); });
            if (lines.length < 2) return [];
            var headers = lines[0].split(',').map(function(h) { return h.trim(); });
            var rows = [];
            for (var i = 1; i < lines.length; i++) {
                var values = lines[i].split(',');
                var obj = {};
                for (var j = 0; j < headers.length; j++) {
                    obj[headers[j]] = (values[j] || '').trim();
                }
                rows.push(obj);
            }
            return rows;
        }

        function handleCsvFile(type, e) {
            var file = e.target.files[0];
            if (!file) return;
            var labelId = {customers:'csvCustLabel', suppliers:'csvSupLabel', projects:'csvProjLabel', ar:'csvArLabel', ap:'csvApLabel', commissions:'csvCommLabel'};
            $(labelId[type]).textContent = file.name;
            var reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    var rows = parseCSV(ev.target.result);
                    if (rows.length === 0) {
                        toast('CSV æª”æ¡ˆç„¡æœ‰æ•ˆè³‡æ–™', 'error');
                        pendingCsvData[type] = null;
                        return;
                    }
                    pendingCsvData[type] = rows;
                    updateCsvPreview();
                } catch(err) {
                    toast('CSV è§£æå¤±æ•—ï¼š' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function updateCsvPreview() {
            var preview = $('csvPreview');
            var labels = {customers:'å®¢æˆ¶', suppliers:'ä¾›æ‡‰å•†', projects:'å°ˆæ¡ˆ', ar:'æ‡‰æ”¶å¸³æ¬¾', ap:'æ‡‰ä»˜å¸³æ¬¾', commissions:'ä½£é‡‘'};
            var hasData = false;
            var html = '<p class="font-bold text-white mb-2">å¾…åŒ¯å…¥è³‡æ–™ï¼š</p>';
            for (var key in pendingCsvData) {
                if (pendingCsvData[key] && pendingCsvData[key].length > 0) {
                    html += '<p class="text-slate-400">' + labels[key] + 'ï¼š<span class="text-green-400">' + pendingCsvData[key].length + ' ç­†</span></p>';
                    hasData = true;
                }
            }
            if (hasData) {
                preview.innerHTML = html;
                preview.classList.remove('hidden');
                $('btnCsvImport').disabled = false;
            } else {
                preview.classList.add('hidden');
                $('btnCsvImport').disabled = true;
            }
        }

        function importCsvData() {
            var importOrder = ['customers', 'suppliers', 'projects', 'ar', 'ap', 'commissions'];
            var counts = {customers:0, suppliers:0, projects:0, ar:0, ap:0, commissions:0};

            // 1. Import customers
            if (pendingCsvData.customers) {
                var custList = getData('customers');
                var existingCodes = {};
                for (var c = 0; c < custList.length; c++) existingCodes[custList[c].code] = true;
                for (var i = 0; i < pendingCsvData.customers.length; i++) {
                    var row = pendingCsvData.customers[i];
                    if (row.code && !existingCodes[row.code]) {
                        custList.push({code: row.code, name: row.name || '', shortName: row.shortName || ''});
                        existingCodes[row.code] = true;
                        counts.customers++;
                    }
                }
                setData('customers', custList);
            }

            // 2. Import suppliers
            if (pendingCsvData.suppliers) {
                var supList = getData('suppliers');
                var existingSupCodes = {};
                for (var s = 0; s < supList.length; s++) existingSupCodes[supList[s].code] = true;
                for (var j = 0; j < pendingCsvData.suppliers.length; j++) {
                    var srow = pendingCsvData.suppliers[j];
                    if (srow.code && !existingSupCodes[srow.code]) {
                        supList.push({code: srow.code, name: srow.name || ''});
                        existingSupCodes[srow.code] = true;
                        counts.suppliers++;
                    }
                }
                setData('suppliers', supList);
            }

            // 3. Import projects
            if (pendingCsvData.projects) {
                var projList = getData('projects');
                var custList2 = getData('customers');
                var existingProjCodes = {};
                for (var p = 0; p < projList.length; p++) existingProjCodes[projList[p].code] = true;
                for (var k = 0; k < pendingCsvData.projects.length; k++) {
                    var prow = pendingCsvData.projects[k];
                    if (prow.code && !existingProjCodes[prow.code]) {
                        var cust = null;
                        for (var cc = 0; cc < custList2.length; cc++) {
                            if (custList2[cc].code === prow.customerCode) { cust = custList2[cc]; break; }
                        }
                        projList.push({
                            id: genId('pj'),
                            code: prow.code,
                            name: prow.name || '',
                            customerCode: cust ? cust.code : '',
                            customerName: cust ? (cust.shortName || cust.name) : '',
                            orderAmount: parseFloat(prow.orderAmount) || 0,
                            materialCost: parseFloat(prow.materialCost) || 0,
                            laborCost: parseFloat(prow.laborCost) || 0,
                            status: prow.status || 'ongoing',
                            commission: 0,
                            collectionRate: 0,
                            bonusStatus: 'pending',
                            bonusPaidDate: null,
                            createdAt: new Date().toISOString()
                        });
                        existingProjCodes[prow.code] = true;
                        counts.projects++;
                    }
                }
                setData('projects', projList);
            }

            // 4. Import AR
            if (pendingCsvData.ar) {
                var arList = getData('ar');
                var projList3 = getData('projects');
                var custList3 = getData('customers');
                for (var a = 0; a < pendingCsvData.ar.length; a++) {
                    var arow = pendingCsvData.ar[a];
                    var proj = null, cust2 = null;
                    for (var pp = 0; pp < projList3.length; pp++) {
                        if (projList3[pp].code === arow.projectCode) { proj = projList3[pp]; break; }
                    }
                    for (var ccc = 0; ccc < custList3.length; ccc++) {
                        if (custList3[ccc].code === arow.customerCode) { cust2 = custList3[ccc]; break; }
                    }
                    if (proj) {
                        arList.push({
                            id: genId('ar'),
                            projectId: proj.id,
                            projectCode: proj.code,
                            customerCode: cust2 ? cust2.code : '',
                            customerName: cust2 ? (cust2.shortName || cust2.name) : '',
                            type: arow.type || 'deposit',
                            amount: parseFloat(arow.amount) || 0,
                            paidAmount: parseFloat(arow.paidAmount) || 0,
                            dueDate: arow.dueDate || '',
                            createdAt: new Date().toISOString()
                        });
                        counts.ar++;
                    }
                }
                setData('ar', arList);
                // Update collection rates
                var projList4 = getData('projects');
                for (var pr = 0; pr < projList4.length; pr++) {
                    updateProjectCollectionRate(projList4[pr].id);
                }
            }

            // 5. Import AP
            if (pendingCsvData.ap) {
                var apList = getData('ap');
                var projList5 = getData('projects');
                var supList2 = getData('suppliers');
                for (var b = 0; b < pendingCsvData.ap.length; b++) {
                    var brow = pendingCsvData.ap[b];
                    var proj2 = null, sup = null;
                    for (var ppp = 0; ppp < projList5.length; ppp++) {
                        if (projList5[ppp].code === brow.projectCode) { proj2 = projList5[ppp]; break; }
                    }
                    for (var ss = 0; ss < supList2.length; ss++) {
                        if (supList2[ss].code === brow.vendorCode) { sup = supList2[ss]; break; }
                    }
                    if (sup) {
                        apList.push({
                            id: genId('ap'),
                            projectId: proj2 ? proj2.id : null,
                            projectCode: proj2 ? proj2.code : '',
                            vendorCode: sup.code,
                            vendorName: sup.name,
                            paymentType: brow.paymentType || 'CHECK',
                            amount: parseFloat(brow.amount) || 0,
                            dueDate: brow.dueDate || '',
                            status: brow.status || 'pending',
                            createdAt: new Date().toISOString()
                        });
                        counts.ap++;
                    }
                }
                setData('ap', apList);
            }

            // 6. Import commissions
            if (pendingCsvData.commissions) {
                var commList = getData('commissions');
                var projList6 = getData('projects');
                for (var m = 0; m < pendingCsvData.commissions.length; m++) {
                    var mrow = pendingCsvData.commissions[m];
                    var proj3 = null;
                    for (var pppp = 0; pppp < projList6.length; pppp++) {
                        if (projList6[pppp].code === mrow.projectCode) { proj3 = projList6[pppp]; break; }
                    }
                    if (proj3) {
                        commList.push({
                            id: genId('cm'),
                            projectId: proj3.id,
                            projectCode: proj3.code,
                            type: mrow.type || 'agent',
                            amount: parseFloat(mrow.amount) || 0,
                            description: mrow.description || '',
                            date: mrow.date || '',
                            createdAt: new Date().toISOString()
                        });
                        counts.commissions++;
                    }
                }
                setData('commissions', commList);
                // Update project commissions
                var projList7 = getData('projects');
                for (var pr2 = 0; pr2 < projList7.length; pr2++) {
                    updateProjectCommission(projList7[pr2].id);
                }
            }

            // Clear pending data and reset UI
            pendingCsvData = {customers:null, suppliers:null, projects:null, ar:null, ap:null, commissions:null};
            $('csvPreview').classList.add('hidden');
            $('btnCsvImport').disabled = true;
            var inputs = ['csvCustomers', 'csvSuppliers', 'csvProjects', 'csvAr', 'csvAp', 'csvCommissions'];
            var labels = ['csvCustLabel', 'csvSupLabel', 'csvProjLabel', 'csvArLabel', 'csvApLabel', 'csvCommLabel'];
            for (var r = 0; r < inputs.length; r++) {
                $(inputs[r]).value = '';
                $(labels[r]).textContent = 'é¸æ“‡æª”æ¡ˆ';
            }
            loadBackupPage();

            var msg = 'åŒ¯å…¥å®Œæˆï¼š';
            if (counts.customers) msg += 'å®¢æˆ¶ ' + counts.customers + ' ç­†ã€';
            if (counts.suppliers) msg += 'ä¾›æ‡‰å•† ' + counts.suppliers + ' ç­†ã€';
            if (counts.projects) msg += 'å°ˆæ¡ˆ ' + counts.projects + ' ç­†ã€';
            if (counts.ar) msg += 'æ‡‰æ”¶ ' + counts.ar + ' ç­†ã€';
            if (counts.ap) msg += 'æ‡‰ä»˜ ' + counts.ap + ' ç­†ã€';
            if (counts.commissions) msg += 'ä½£é‡‘ ' + counts.commissions + ' ç­†ã€';
            msg = msg.replace(/ã€$/, '');
            toast(msg, 'success');
        }

        // ============== äº‹ä»¶ç¶å®š ==============
        function initEvents() {
            var sidebarItems = $$('.sidebar-item');
            for (var i = 0; i < sidebarItems.length; i++) {
                sidebarItems[i].addEventListener('click', function() {
                    var page = this.getAttribute('data-page');
                    if (page) showPage(page);
                });
            }

            // Buttons
            $('btnAddAr').addEventListener('click', function() { openArModal(); });
            $('btnAddAp').addEventListener('click', function() { openApModal(); });
            $('btnAddProject').addEventListener('click', function() { openProjectModal(); });
            $('btnAddCommission').addEventListener('click', function() { openCommissionModal(); });
            $('btnCalcBonus').addEventListener('click', function() { loadBonusList(); toast('å·²é‡æ–°è¨ˆç®—', 'success'); });
            $('btnSaveCompany').addEventListener('click', function() { saveCompanySettings(); });
            $('btnAddCustomer').addEventListener('click', function() { openCustomerModal(); });
            $('btnAddSupplier').addEventListener('click', function() { openSupplierModal(); });
            $('btnExport').addEventListener('click', function() { exportData(); });
            $('btnImport').addEventListener('click', function() { importData(); });
            $('importFile').addEventListener('change', handleImportFile);

            // CSV import events
            $('csvCustomers').addEventListener('change', function(e) { handleCsvFile('customers', e); });
            $('csvSuppliers').addEventListener('change', function(e) { handleCsvFile('suppliers', e); });
            $('csvProjects').addEventListener('change', function(e) { handleCsvFile('projects', e); });
            $('csvAr').addEventListener('change', function(e) { handleCsvFile('ar', e); });
            $('csvAp').addEventListener('change', function(e) { handleCsvFile('ap', e); });
            $('csvCommissions').addEventListener('change', function(e) { handleCsvFile('commissions', e); });
            $('btnCsvImport').addEventListener('click', function() { importCsvData(); });

            // Delegated click events
            document.addEventListener('click', function(e) {
                var target = e.target;

                // AR
                if (target.hasAttribute('data-edit-ar')) openArModal(target.getAttribute('data-edit-ar'));
                if (target.hasAttribute('data-pay-ar')) openPayArModal(target.getAttribute('data-pay-ar'));
                if (target.hasAttribute('data-delete-ar')) deleteAr(target.getAttribute('data-delete-ar'));
                // AP
                if (target.hasAttribute('data-edit-ap')) openApModal(target.getAttribute('data-edit-ap'));
                if (target.hasAttribute('data-pay-ap')) markApPaid(target.getAttribute('data-pay-ap'));
                if (target.hasAttribute('data-delete-ap')) deleteAp(target.getAttribute('data-delete-ap'));
                // Projects
                if (target.hasAttribute('data-edit-project')) openProjectModal(target.getAttribute('data-edit-project'));
                if (target.hasAttribute('data-delete-project')) deleteProject(target.getAttribute('data-delete-project'));
                // Commission
                if (target.hasAttribute('data-edit-comm')) openCommissionModal(target.getAttribute('data-edit-comm'));
                if (target.hasAttribute('data-delete-comm')) deleteCommission(target.getAttribute('data-delete-comm'));
                // Bonus
                if (target.hasAttribute('data-pay-bonus')) markBonusPaid(target.getAttribute('data-pay-bonus'));
                if (target.hasAttribute('data-cancel-bonus')) cancelBonusPaid(target.getAttribute('data-cancel-bonus'));
                // Settings
                if (target.hasAttribute('data-edit-customer')) openCustomerModal(target.getAttribute('data-edit-customer'));
                if (target.hasAttribute('data-delete-customer')) deleteCustomer(target.getAttribute('data-delete-customer'));
                if (target.hasAttribute('data-edit-supplier')) openSupplierModal(target.getAttribute('data-edit-supplier'));
                if (target.hasAttribute('data-delete-supplier')) deleteSupplier(target.getAttribute('data-delete-supplier'));
            });

            // Search inputs
            $('arSearch').addEventListener('input', function() { loadArList(); });
            $('apSearch').addEventListener('input', function() { loadApList(); });
            $('projectSearch').addEventListener('input', function() { loadProjectList(); });
            $('commSearch').addEventListener('input', function() { loadCommissionList(); });
        }

        // ============== åˆå§‹åŒ– ==============
        function init() {
            console.log('æ™ºéµæ©Ÿæ¢°è²¡å‹™ç®¡ç†ç³»çµ± v' + VERSION + ' å•Ÿå‹•');
            initEvents();
            loadDashboard();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
